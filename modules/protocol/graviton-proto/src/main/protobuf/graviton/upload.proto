syntax = "proto3";

package graviton.upload.v1;

option java_multiple_files = true;
option java_package = "io.graviton.upload.v1";
option java_outer_classname = "UploadProto";
option optimize_for = SPEED;

message RegisterUploadRequest {
  string file_name = 1;
  uint64 file_size = 2;
  string media_type = 3;
  map<string, MetadataNamespace> metadata = 4;
  uint32 preferred_chunk_size = 5;
}

message MetadataNamespace {
  map<string, string> fields = 1;
}

message RegisterUploadResponse {
  string upload_id = 1;
  uint32 chunk_size = 2;
  uint32 max_chunks = 3;
  uint64 expires_at_epoch_seconds = 4;
}

message UploadChunk {
  string upload_id = 1;
  uint32 sequence_number = 2;
  uint64 offset = 3;
  bytes data = 4;
  string checksum = 5;
  bool last = 6;
}

message UploadAck {
  string upload_id = 1;
  uint32 acknowledged_sequence = 2;
  uint64 received_bytes = 3;
}

message UploadedPart {
  uint32 part_number = 1;
  uint64 offset = 2;
  uint64 size = 3;
  string checksum = 4;
}

message CompleteUploadRequest {
  string upload_id = 1;
  repeated UploadedPart parts = 2;
  string expected_checksum = 3;
}

message CompleteUploadResponse {
  string document_id = 1;
  map<string, string> attributes = 2;
}

service UploadService {
  rpc RegisterUpload (RegisterUploadRequest) returns (RegisterUploadResponse);
  rpc UploadParts (stream UploadChunk) returns (stream UploadAck);
  rpc CompleteUpload (CompleteUploadRequest) returns (CompleteUploadResponse);
}
