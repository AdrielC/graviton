2025-11-06 — Migration Sync Log
================================

Context
-------
- `main` currently carries the slimmed-down core (Tracked attributes, VitePress docs, fixed-size chunker) and clean build.
- `docs-deploy` introduces the richer storage/ingest/chunking stack, revamped docs site (Docusaurus + React components), extensive script updates, and regenerated PG bindings.
- Goal: reintroduce the "good ideas" (strong types, composable chunking/scans, ingest pipeline, richer docs) without regressing stability, and publish docs updates incrementally.

Immediate Actions
-----------------
- Keep working branch rebased on `main`; cherry-pick or selectively merge from `origin/docs-deploy` as features are stabilized.
- Confirm baseline green (`TESTCONTAINERS=0 ./sbt scalafmtAll test`).
- Preserve `Tracked[A]` model in BinaryAttributes while layering new opaque/refined types on top.

Merge Strategy (docs-deploy ➜ main)
-----------------------------------
1. **Phase 0 — Baseline**
   - Branch from `main`, ensure clean lint/test state.
2. **Phase 1 — Type Foundations**
   - Restore opaque/refined wrappers: `Block`, `UploadChunk`, `BlockSize`, `BlockIndex`, `FileSize`, `ChunkSize`.
   - Add smart constructors (no throws) + unit tests.
3. **Phase 2 — Chunkers & Selection**
   - Port FastCDC / rolling-hash / token-aware chunkers and `Chunker.select(hints)`.
   - Integrate with new size/index types; cover with spec tests & throughput sanity.
4. **Phase 3 — Mime Sniffer Pass 1**
   - Standalone module for magic-number detection; expose early-exit streaming API.
5. **Phase 4 — Ingest Pipeline (minimal)**
   - FileIngestor driving chunker → `Block` stream → hashing → manifest + attributes.
   - End-to-end FS/in-memory tests.
6. **Phase 5 — Storage Substrates**
   - Introduce temp-file pool + direct buffer pool; semaphore-guarded usage metrics.
   - Optional mmap read cache (feature flag).
7. **Phase 6 — Planner & Free Scans**
   - Bring back FreeScan/FreeArrow with Descriptor (compile-time) + runtime hints.
   - Basic optimizer for policy selection.
8. **Phase 7 — Docs & Website**
   - Wire `sbt mdoc` alongside VitePress; surface new docs (types, chunking, scans, ingest, storage substrate, sniffing).
   - Run docs build + link checker; ensure npm deps updated.
9. **Phase 8 — Optional Extras**
   - PG/codegen improvements, FS cache refinements, CLI samples as separate PRs.

Docs & Website Plan
-------------------
- Maintain VitePress as the published surface; land Docusaurus content gradually via mdoc-to-VitePress pipeline.
- Add `docs/mdoc/` with literate examples that generate shared snippets.
- For each phase above, append or update guides (type guide, chunking strategies, ingest walkthrough, storage substrate, sniffing best practices).
- Keep job logs (this directory) up to date; prune stale `AGENTS.md` entries after confirming no active tasks reference them.

Streaming & Storage Default Notes
---------------------------------
- Target zero/minimal copy paths: `FileChannel` + pooled direct buffers, `transferTo/transferFrom` when available.
- Maintain a semaphore-guarded temp-file pool for hot uploads; track usage per upload via STM registry (bytes, blocks, temp slices, open FDs).
- Evaluate mmap read cache for hot-path reads (opt-in, platform-aware).
- Future exploration: io_uring-backed writer; gate behind capability flag and benchmarks.

Work Queue Snapshot
-------------------
- [ ] Prepare scaffolding PR (Phase 1 types + tests).
- [ ] Author chunker selection spec + FastCDC/Rolling pipelines (Phase 2).
- [ ] Draft mime sniffer module outline + fixtures (Phase 3).
- [ ] Create docs/guide stubs and mdoc wiring (Phase 7 groundwork).
- [ ] Schedule cleanup pass for outdated `AGENTS.md` entries once playbook lands.
- [ ] Capture substrate benchmark plan (temp files vs mmap vs io_uring) in follow-up log.

External Checks
---------------
- Build/tests: `TESTCONTAINERS=0 ./sbt scalafmtAll test`.
- Docs preview: `cd docs && npm ci && npm run docs:dev` (until mdoc integration available).
- PG workflow (if touched): `scripts/ensure-postgres.sh` + codegen regeneration checklist.

